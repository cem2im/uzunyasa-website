<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecem - Saƒülƒ±k Asistanƒ±nƒ±z | UzunYa≈üa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-teal: #195157;
            --primary-teal-light: #2a6b73;
            --accent-orange: #E8963E;
            --accent-orange-light: #f0a854;
            --text-dark: #1a1a1a;
            --text-gray: #6b7280;
            --bg-cream: #FAF9F7;
            --bg-white: #FFFFFF;
            --border-light: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--bg-cream);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-img { height: 50px; }

        .progress-container {
            flex: 1;
            max-width: 400px;
            margin: 0 2rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-teal), var(--accent-orange));
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 0.25rem;
            text-align: center;
        }

        .exit-btn {
            color: var(--text-gray);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Chat Container */
        .chat-container {
            max-width: 700px;
            margin: 0 auto;
            padding: 2rem;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 2rem;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.25rem;
        }

        .avatar.bot {
            background: linear-gradient(135deg, #E8963E, #f0a854);
            color: white;
            font-size: 1.5rem;
        }

        .avatar.user {
            background: var(--accent-orange);
            color: white;
        }

        .bubble {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .message.bot .bubble {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 4px;
        }

        .message.user .bubble {
            background: var(--primary-teal);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.5rem 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-gray);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Options */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .option-btn {
            padding: 0.875rem 1.5rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .option-btn:hover {
            border-color: var(--primary-teal);
            color: var(--primary-teal);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
            color: white;
        }

        .option-btn.multi-select.selected {
            background: var(--primary-teal-light);
        }

        /* Input Types */
        .input-container {
            margin-top: 1rem;
        }

        .text-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--primary-teal);
        }

        .input-row {
            display: flex;
            gap: 1rem;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.5rem;
        }

        .slider-container {
            padding: 1rem 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-light);
            appearance: none;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-teal);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 0.5rem;
        }

        .slider-value {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-teal);
            margin-bottom: 0.5rem;
        }

        /* Continue Button */
        .continue-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-orange-light));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1.5rem;
            font-family: inherit;
        }

        .continue-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(232, 150, 62, 0.4);
        }

        .continue-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Results Screen */
        .results-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-header h1 {
            font-size: 2rem;
            color: var(--primary-teal);
            margin-bottom: 0.5rem;
        }

        .results-header p {
            color: var(--text-gray);
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: conic-gradient(
                var(--primary-teal) calc(var(--score) * 3.6deg),
                var(--border-light) 0deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            position: relative;
        }

        .score-inner {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: var(--bg-cream);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-teal);
            line-height: 1;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .risk-badge {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .risk-badge.low { background: #D1FAE5; color: #065F46; }
        .risk-badge.moderate { background: #FEF3C7; color: #92400E; }
        .risk-badge.high { background: #FEE2E2; color: #991B1B; }

        /* Summary Cards */
        .summary-section {
            margin-top: 2rem;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .summary-card {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .summary-card h4 {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-bottom: 0.25rem;
        }

        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .summary-card .status {
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .status.good { color: #059669; }
        .status.warning { color: #D97706; }
        .status.alert { color: #DC2626; }

        /* Recommendations */
        .recommendations {
            margin-top: 2rem;
        }

        .rec-card {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s;
        }

        .rec-card:hover {
            border-color: var(--primary-teal);
            transform: translateX(5px);
        }

        .rec-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .rec-icon.guide { background: #DBEAFE; }
        .rec-icon.tool { background: #D1FAE5; }
        .rec-icon.treatment { background: #FEE2E2; }
        .rec-icon.lifestyle { background: #FEF3C7; }

        .rec-content h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .rec-content p {
            font-size: 0.9rem;
            color: var(--text-gray);
        }

        .rec-arrow {
            margin-left: auto;
            color: var(--primary-teal);
            font-size: 1.25rem;
            align-self: center;
        }

        /* Priority Tags */
        .priority-tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .priority-tag.high { background: #FEE2E2; color: #991B1B; }
        .priority-tag.medium { background: #FEF3C7; color: #92400E; }

        /* Actions */
        .results-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            border: none;
            font-family: inherit;
        }

        .action-btn.primary {
            background: var(--primary-teal);
            color: white;
        }

        .action-btn.secondary {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            color: var(--text-dark);
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* JSON Debug (hidden by default) */
        .json-debug {
            margin-top: 2rem;
            padding: 1rem;
            background: #1a1a1a;
            border-radius: 12px;
            display: none;
        }

        .json-debug pre {
            color: #10B981;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .progress-container { display: none; }
            .chat-container { padding: 1rem; }
            .summary-grid { grid-template-columns: 1fr; }
            .results-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="../index.html">
            <img src="../images/logo.svg" alt="UzunYa≈üa" class="logo-img">
        </a>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Ba≈ülangƒ±√ß</div>
        </div>
        <a href="../index.html" class="exit-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            √áƒ±k
        </a>
    </header>

    <div class="chat-container">
        <div class="messages" id="messages"></div>
    </div>

    <div class="chat-container results-container" id="results-container">
        <!-- Results will be injected here -->
    </div>

    <script>
        // Witty Turkish - Conversational Health Assessment
        
        const QUESTIONS = [
            {
                id: 'welcome',
                type: 'info',
                message: 'Merhaba! üëã Ben Ecem, UzunYa≈üa saƒülƒ±k asistanƒ±nƒ±z. Size birka√ß soru soracaƒüƒ±m ve sonunda size √∂zel √∂neriler hazƒ±rlayacaƒüƒ±m.',
                delay: 1000,
                auto: true
            },
            {
                id: 'name',
                type: 'text',
                message: '√ñnce tanƒ±≈üalƒ±m. Adƒ±nƒ±z nedir?',
                placeholder: 'Adƒ±nƒ±zƒ± yazƒ±n...',
                field: 'name'
            },
            {
                id: 'goal',
                type: 'single',
                message: 'G√ºzel tanƒ±≈ütƒ±ƒüƒ±mƒ±za memnun oldum, {name}! üòä Bug√ºn buraya hangi ama√ßla geldiniz?',
                options: [
                    { value: 'lose_weight', label: '‚öñÔ∏è Kilo vermek istiyorum', score: 0 },
                    { value: 'health_check', label: 'ü©∫ Saƒülƒ±ƒüƒ±mƒ± kontrol etmek', score: 0 },
                    { value: 'prevent_disease', label: 'üõ°Ô∏è Hastalƒ±klardan korunmak', score: 0 },
                    { value: 'improve_lifestyle', label: 'üå± Ya≈üam tarzƒ±mƒ± iyile≈ütirmek', score: 0 },
                    { value: 'manage_condition', label: 'üíä Mevcut bir durumu y√∂netmek', score: 0 }
                ],
                field: 'primaryGoal'
            },
            {
                id: 'age',
                type: 'single',
                message: 'Ya≈ü grubunuzu √∂ƒürenebilir miyim?',
                options: [
                    { value: '18-29', label: '18-29', riskScore: 0 },
                    { value: '30-39', label: '30-39', riskScore: 5 },
                    { value: '40-49', label: '40-49', riskScore: 10 },
                    { value: '50-59', label: '50-59', riskScore: 15 },
                    { value: '60+', label: '60+', riskScore: 20 }
                ],
                field: 'ageGroup'
            },
            {
                id: 'gender',
                type: 'single',
                message: 'Cinsiyetiniz nedir?',
                options: [
                    { value: 'male', label: 'üë® Erkek' },
                    { value: 'female', label: 'üë© Kadƒ±n' },
                    { value: 'other', label: 'üßë Belirtmek istemiyorum' }
                ],
                field: 'gender'
            },
            {
                id: 'measurements',
                type: 'measurements',
                message: '≈ûimdi bazƒ± √∂l√ß√ºmlerinizi alalƒ±m. Boy ve kilonuz nedir?',
                fields: ['height', 'weight']
            },
            {
                id: 'waist',
                type: 'number',
                message: 'Bel √ßevrenizi biliyor musunuz? (cm cinsinden)',
                placeholder: '√ñrn: 85',
                field: 'waistCircumference',
                optional: true,
                skipLabel: 'Bilmiyorum'
            },
            {
                id: 'activity',
                type: 'single',
                message: 'Fiziksel aktivite d√ºzeyinizi nasƒ±l tanƒ±mlarsƒ±nƒ±z?',
                options: [
                    { value: 'sedentary', label: 'ü™ë Hareketsiz (masa ba≈üƒ± i≈ü)', riskScore: 15 },
                    { value: 'light', label: 'üö∂ Hafif aktif (haftada 1-2 g√ºn)', riskScore: 10 },
                    { value: 'moderate', label: 'üèÉ Orta aktif (haftada 3-5 g√ºn)', riskScore: 5 },
                    { value: 'active', label: 'üí™ √áok aktif (haftada 6-7 g√ºn)', riskScore: 0 }
                ],
                field: 'activityLevel'
            },
            {
                id: 'diet',
                type: 'single',
                message: 'Beslenme alƒ±≈ükanlƒ±klarƒ±nƒ±zƒ± nasƒ±l deƒüerlendirirsiniz?',
                options: [
                    { value: 'poor', label: 'üçî Saƒülƒ±ksƒ±z (i≈ülenmi≈ü gƒ±dalar, fast food)', riskScore: 15 },
                    { value: 'average', label: 'üçΩÔ∏è Orta (karƒ±≈üƒ±k, dikkat etmeye √ßalƒ±≈üƒ±yorum)', riskScore: 8 },
                    { value: 'good', label: 'ü•ó ƒ∞yi (√ßoƒüunlukla saƒülƒ±klƒ±)', riskScore: 3 },
                    { value: 'excellent', label: 'ü•ë √áok iyi (bilin√ßli besleniyorum)', riskScore: 0 }
                ],
                field: 'dietQuality'
            },
            {
                id: 'sleep',
                type: 'slider',
                message: 'Ortalama ka√ß saat uyuyorsunuz?',
                min: 3,
                max: 12,
                default: 7,
                unit: 'saat',
                field: 'sleepHours'
            },
            {
                id: 'sleep_quality',
                type: 'single',
                message: 'Uyku kalitenizi nasƒ±l deƒüerlendirirsiniz?',
                options: [
                    { value: 'poor', label: 'üò´ K√∂t√º (s√ºrekli yorgun uyanƒ±yorum)', riskScore: 10 },
                    { value: 'fair', label: 'üòê Orta (bazen iyi, bazen k√∂t√º)', riskScore: 5 },
                    { value: 'good', label: 'üòä ƒ∞yi (genellikle dinlenmi≈ü uyanƒ±yorum)', riskScore: 0 }
                ],
                field: 'sleepQuality'
            },
            {
                id: 'stress',
                type: 'single',
                message: 'G√ºnl√ºk stres d√ºzeyiniz nasƒ±l?',
                options: [
                    { value: 'high', label: 'üî¥ Y√ºksek (s√ºrekli stres altƒ±ndayƒ±m)', riskScore: 12 },
                    { value: 'moderate', label: 'üü° Orta (zaman zaman stresli)', riskScore: 6 },
                    { value: 'low', label: 'üü¢ D√º≈ü√ºk (genel olarak sakinim)', riskScore: 0 }
                ],
                field: 'stressLevel'
            },
            {
                id: 'smoking',
                type: 'single',
                message: 'Sigara kullanƒ±yor musunuz?',
                options: [
                    { value: 'yes', label: 'üö¨ Evet, aktif i√ßiciyim', riskScore: 20 },
                    { value: 'former', label: 'üö≠ Bƒ±raktƒ±m', riskScore: 5 },
                    { value: 'no', label: '‚ùå Hayƒ±r, hi√ß i√ßmedim', riskScore: 0 }
                ],
                field: 'smoking'
            },
            {
                id: 'alcohol',
                type: 'single',
                message: 'Alkol t√ºketim sƒ±klƒ±ƒüƒ±nƒ±z nedir?',
                options: [
                    { value: 'daily', label: 'üç∑ Her g√ºn', riskScore: 15 },
                    { value: 'weekly', label: 'üç∫ Haftada birka√ß kez', riskScore: 8 },
                    { value: 'occasional', label: 'ü•Ç Nadiren (ayda birka√ß kez)', riskScore: 2 },
                    { value: 'never', label: 'üö´ Hi√ß i√ßmiyorum', riskScore: 0 }
                ],
                field: 'alcohol'
            },
            {
                id: 'conditions',
                type: 'multi',
                message: 'A≈üaƒüƒ±dakilerden size te≈ühis konulmu≈ü olanlarƒ± se√ßin (varsa):',
                options: [
                    { value: 'diabetes', label: 'üíâ Tip 2 Diyabet', riskScore: 15 },
                    { value: 'prediabetes', label: '‚ö†Ô∏è Pre-diyabet', riskScore: 10 },
                    { value: 'hypertension', label: 'üíì Hipertansiyon', riskScore: 12 },
                    { value: 'heart_disease', label: '‚ù§Ô∏è Kalp hastalƒ±ƒüƒ±', riskScore: 15 },
                    { value: 'high_cholesterol', label: 'ü©∏ Y√ºksek kolesterol', riskScore: 8 },
                    { value: 'sleep_apnea', label: 'üò¥ Uyku apnesi', riskScore: 8 },
                    { value: 'fatty_liver', label: 'ü´ò Yaƒülƒ± karaciƒüer', riskScore: 7 },
                    { value: 'pcos', label: 'üî¨ PCOS', riskScore: 5 },
                    { value: 'none', label: '‚úÖ Hi√ßbiri', riskScore: 0, exclusive: true }
                ],
                field: 'existingConditions'
            },
            {
                id: 'family_history',
                type: 'multi',
                message: 'Ailenizde (anne, baba, karde≈ü) a≈üaƒüƒ±daki hastalƒ±klardan var mƒ±?',
                options: [
                    { value: 'diabetes', label: 'üíâ Diyabet', riskScore: 8 },
                    { value: 'heart_disease', label: '‚ù§Ô∏è Kalp hastalƒ±ƒüƒ±', riskScore: 10 },
                    { value: 'obesity', label: '‚öñÔ∏è Obezite', riskScore: 5 },
                    { value: 'cancer', label: 'üéóÔ∏è Kanser', riskScore: 5 },
                    { value: 'none', label: '‚úÖ Hi√ßbiri', riskScore: 0, exclusive: true }
                ],
                field: 'familyHistory'
            },
            {
                id: 'previous_attempts',
                type: 'single',
                message: 'Daha √∂nce kilo vermeyi denediniz mi?',
                options: [
                    { value: 'many_failed', label: 'üòî Evet, bir√ßok kez denedim ama ba≈üarƒ±sƒ±z oldum' },
                    { value: 'some_success', label: 'üîÑ Evet, verdim ama geri aldƒ±m' },
                    { value: 'first_time', label: 'üÜï Hayƒ±r, ilk kez ciddi deniyorum' },
                    { value: 'maintaining', label: '‚úÖ Evet, ≈üu an koruyorum' }
                ],
                field: 'previousAttempts',
                showIf: (data) => data.primaryGoal === 'lose_weight'
            },
            {
                id: 'treatment_interest',
                type: 'multi',
                message: 'Hangi yakla≈üƒ±mlarƒ± deƒüerlendirmeye a√ßƒ±ksƒ±nƒ±z?',
                options: [
                    { value: 'diet_only', label: 'ü•ó Sadece beslenme deƒüi≈üikliƒüi' },
                    { value: 'exercise', label: 'üèãÔ∏è Egzersiz programƒ±' },
                    { value: 'medication', label: 'üíä ƒ∞la√ß tedavisi (GLP-1 vb.)' },
                    { value: 'surgery', label: 'üè• Cerrahi se√ßenekler' },
                    { value: 'all', label: 'üìã Hepsini deƒüerlendirmek istiyorum' }
                ],
                field: 'treatmentInterest',
                showIf: (data) => data.primaryGoal === 'lose_weight' || data.primaryGoal === 'manage_condition'
            },
            {
                id: 'motivation',
                type: 'single',
                message: 'Son soru! ≈ûu an deƒüi≈üim i√ßin ne kadar hazƒ±r hissediyorsunuz?',
                options: [
                    { value: 'very_ready', label: 'üî• √áok hazƒ±rƒ±m, hemen ba≈ülamak istiyorum', motivationScore: 100 },
                    { value: 'ready', label: '‚úÖ Hazƒ±rƒ±m, plan yapmak istiyorum', motivationScore: 80 },
                    { value: 'considering', label: 'ü§î D√º≈ü√ºn√ºyorum, bilgi topluyorum', motivationScore: 50 },
                    { value: 'not_sure', label: '‚ùì Emin deƒüilim, sadece merak ediyorum', motivationScore: 30 }
                ],
                field: 'motivationLevel'
            }
        ];

        // Comprehensive Recommendation Rules based on ROUTING_RULES.md
        const RECOMMENDATION_RULES = {
            // URGENT - Always show first
            urgent: [
                {
                    id: 'morbid_obesity_referral',
                    condition: (d) => d.calculatedBMI >= 40,
                    title: 'üö® Acil Uzman Kons√ºltasyonu',
                    description: 'BMI deƒüeriniz √ßok y√ºksek. Multidisipliner bir ekiple g√∂r√º≈ümenizi √∂neririz.',
                    icon: 'üè•',
                    type: 'urgent',
                    link: 'tedavi.html#uzman',
                    priority: 'urgent',
                    reason: 'BMI ‚â• 40 (Morbid Obezite)'
                },
                {
                    id: 'high_risk_combo',
                    condition: (d) => d.calculatedBMI >= 35 && 
                        (d.existingConditions?.includes('diabetes') || d.existingConditions?.includes('heart_disease')),
                    title: 'üö® Y√ºksek Risk - Uzman Deƒüerlendirmesi',
                    description: 'Obezite ve e≈ülik eden hastalƒ±klarƒ±nƒ±z nedeniyle kapsamlƒ± deƒüerlendirme gerekli.',
                    icon: '‚ö†Ô∏è',
                    type: 'urgent',
                    link: 'tedavi.html#uzman',
                    priority: 'urgent',
                    reason: 'BMI ‚â• 35 + Diyabet/Kalp Hastalƒ±ƒüƒ±'
                },
                {
                    id: 'quit_smoking_urgent',
                    condition: (d) => d.smoking === 'yes' && d.calculatedBMI >= 30,
                    title: 'üö≠ Sigarayƒ± Bƒ±rakma - √ñncelikli',
                    description: 'Obezite + sigara kombinasyonu √ßok y√ºksek risk. Bƒ±rakma desteƒüi alƒ±n.',
                    icon: 'üö≠',
                    type: 'urgent',
                    link: 'rehberler.html#sigara',
                    priority: 'urgent',
                    reason: 'Sigara + Obezite'
                }
            ],

            // TREATMENT OPTIONS based on BMI
            treatments: [
                // BMI 30-34.9: GLP-1 primary
                {
                    id: 'glp1_class1',
                    condition: (d) => d.calculatedBMI >= 30 && d.calculatedBMI < 35 && 
                        (d.treatmentInterest?.includes('medication') || d.treatmentInterest?.includes('all')),
                    title: 'GLP-1 ƒ∞la√ßlarƒ± (Ozempic, Wegovy)',
                    description: 'BMI 30+ i√ßin etkili medikal tedavi se√ßeneƒüi. %15-20 kilo kaybƒ± m√ºmk√ºn.',
                    icon: 'üíä',
                    type: 'treatment',
                    link: 'tedavi.html#glp1',
                    priority: 'high',
                    reason: 'BMI 30-35 + ƒ∞la√ß tedavisi tercihi'
                },
                // BMI 27-30 with comorbidity
                {
                    id: 'glp1_with_comorbidity',
                    condition: (d) => d.calculatedBMI >= 27 && d.calculatedBMI < 30 &&
                        (d.existingConditions?.includes('diabetes') || d.existingConditions?.includes('prediabetes') || 
                         d.existingConditions?.includes('hypertension')),
                    title: 'GLP-1 ƒ∞la√ßlarƒ± Deƒüerlendirmesi',
                    description: 'E≈ülik eden hastalƒ±ƒüƒ±nƒ±z nedeniyle BMI 27+ i√ßin de uygun olabilir.',
                    icon: 'üíä',
                    type: 'treatment',
                    link: 'tedavi.html#glp1',
                    priority: 'high',
                    reason: 'BMI 27-30 + Komorbidite'
                },
                // BMI 30-40: Endoscopic options
                {
                    id: 'endoscopic_options',
                    condition: (d) => d.calculatedBMI >= 30 && d.calculatedBMI < 40 &&
                        (d.treatmentInterest?.includes('surgery') || d.treatmentInterest?.includes('all')),
                    title: 'Endoskopik Tedaviler (Balon, ESG)',
                    description: 'Cerrahisiz, minimal invaziv se√ßenekler. Mide balonu veya ESG.',
                    icon: 'üî¨',
                    type: 'treatment',
                    link: 'tedavi.html#endoskopik',
                    priority: 'medium',
                    reason: 'BMI 30-40 aralƒ±ƒüƒ±'
                },
                // BMI 35+: Bariatric surgery
                {
                    id: 'bariatric_surgery',
                    condition: (d) => d.calculatedBMI >= 35 &&
                        (d.treatmentInterest?.includes('surgery') || d.treatmentInterest?.includes('all')),
                    title: 'Bariatrik Cerrahi Se√ßenekleri',
                    description: 'Sleeve gastrektomi veya gastrik bypass. Kalƒ±cƒ± √ß√∂z√ºm arayanlar i√ßin.',
                    icon: 'üè•',
                    type: 'treatment',
                    link: 'tedavi.html#cerrahi',
                    priority: 'high',
                    reason: 'BMI ‚â• 35'
                },
                // BMI 30-35 with severe comorbidity: Surgery eligible
                {
                    id: 'bariatric_with_comorbidity',
                    condition: (d) => d.calculatedBMI >= 30 && d.calculatedBMI < 35 &&
                        (d.existingConditions?.includes('diabetes') && d.existingConditions?.includes('hypertension')) &&
                        d.treatmentInterest?.includes('surgery'),
                    title: 'Metabolik Cerrahi Deƒüerlendirmesi',
                    description: 'Diyabet + hipertansiyon kombinasyonunda BMI 30+ i√ßin cerrahi d√º≈ü√ºn√ºlebilir.',
                    icon: 'üè•',
                    type: 'treatment',
                    link: 'tedavi.html#metabolik',
                    priority: 'medium',
                    reason: 'BMI 30-35 + Ciddi Komorbidite'
                }
            ],

            // GUIDES based on conditions
            guides: [
                // Weight loss
                {
                    id: 'weight_loss_guide',
                    condition: (d) => d.primaryGoal === 'lose_weight' || d.calculatedBMI >= 25,
                    title: 'Kilo Verme Ba≈ülangƒ±√ß Rehberi',
                    description: 'Adƒ±m adƒ±m, s√ºrd√ºr√ºlebilir kilo kaybƒ± stratejileri.',
                    icon: 'üìñ',
                    type: 'guide',
                    link: 'rehberler.html',
                    priority: 'high',
                    reason: 'Kilo verme hedefi'
                },
                // Diabetes management
                {
                    id: 'diabetes_management',
                    condition: (d) => d.existingConditions?.includes('diabetes'),
                    title: 'Diyabet Y√∂netimi Rehberi',
                    description: 'Kan ≈üekeri kontrol√º, beslenme ve egzersiz √∂nerileri.',
                    icon: 'üíâ',
                    type: 'guide',
                    link: 'rehberler.html#diyabet',
                    priority: 'high',
                    reason: 'Tip 2 Diyabet tanƒ±sƒ±'
                },
                // Diabetes prevention
                {
                    id: 'diabetes_prevention',
                    condition: (d) => d.existingConditions?.includes('prediabetes') || 
                        (d.familyHistory?.includes('diabetes') && d.calculatedBMI >= 25),
                    title: 'Diyabet √ñnleme Rehberi',
                    description: 'Pre-diyabetten diyabete ge√ßi≈üi √∂nleme stratejileri.',
                    icon: 'üõ°Ô∏è',
                    type: 'guide',
                    link: 'rehberler.html#diyabet-onleme',
                    priority: 'high',
                    reason: 'Pre-diyabet veya aile √∂yk√ºs√º + fazla kilo'
                },
                // Heart health
                {
                    id: 'heart_health',
                    condition: (d) => d.existingConditions?.includes('hypertension') || 
                        d.existingConditions?.includes('high_cholesterol') ||
                        d.existingConditions?.includes('heart_disease') ||
                        d.familyHistory?.includes('heart_disease'),
                    title: 'Kalp Saƒülƒ±ƒüƒ± Rehberi',
                    description: 'Kardiyovask√ºler riski azaltma, DASH diyeti, egzersiz.',
                    icon: '‚ù§Ô∏è',
                    type: 'guide',
                    link: 'rehberler.html#kalp',
                    priority: 'high',
                    reason: 'Kardiyovask√ºler risk fakt√∂rleri'
                },
                // Mediterranean diet
                {
                    id: 'mediterranean_diet',
                    condition: (d) => d.dietQuality === 'poor' || d.dietQuality === 'average',
                    title: 'Akdeniz Diyeti Rehberi',
                    description: 'D√ºnyanƒ±n en saƒülƒ±klƒ± beslenme tarzƒ±na ge√ßi≈ü.',
                    icon: 'ü•ó',
                    type: 'guide',
                    link: 'rehberler.html#akdeniz',
                    priority: 'medium',
                    reason: 'Beslenme kalitesi iyile≈ütirilebilir'
                },
                // Intermittent fasting
                {
                    id: 'intermittent_fasting',
                    condition: (d) => d.primaryGoal === 'lose_weight' && d.calculatedBMI >= 25 &&
                        d.existingConditions?.includes('prediabetes'),
                    title: 'Aralƒ±klƒ± Oru√ß Rehberi',
                    description: 'ƒ∞ns√ºlin direnci ve kilo y√∂netimi i√ßin 16:8 ve 5:2 y√∂ntemleri.',
                    icon: '‚è∞',
                    type: 'guide',
                    link: 'rehberler.html#aralikli-oruc',
                    priority: 'medium',
                    reason: 'Pre-diyabet + Kilo verme hedefi'
                },
                // Exercise for sedentary
                {
                    id: 'exercise_beginner',
                    condition: (d) => d.activityLevel === 'sedentary',
                    title: 'Evde Egzersiz Ba≈ülangƒ±√ß Rehberi',
                    description: 'Sƒ±fƒ±rdan ba≈ülayanlar i√ßin 4 haftalƒ±k program.',
                    icon: 'üèÉ',
                    type: 'guide',
                    link: 'rehberler.html#egzersiz',
                    priority: 'high',
                    reason: 'Hareketsiz ya≈üam tarzƒ±'
                },
                // Exercise for 50+
                {
                    id: 'exercise_senior',
                    condition: (d) => d.ageGroup === '60+',
                    title: '50 Ya≈ü √úst√º Egzersiz Rehberi',
                    description: 'G√ºvenli, ya≈üa uygun egzersiz √∂nerileri.',
                    icon: 'üßì',
                    type: 'guide',
                    link: 'rehberler.html#50plus',
                    priority: 'medium',
                    reason: 'Ya≈ü grubu 60+'
                },
                // Sleep guide
                {
                    id: 'sleep_guide',
                    condition: (d) => d.sleepQuality === 'poor' || d.sleepHours < 6 || 
                        d.existingConditions?.includes('sleep_apnea'),
                    title: 'Uyku Kalitesi Rehberi',
                    description: 'Uyku hijyeni ve uyku bozukluklarƒ± hakkƒ±nda.',
                    icon: 'üò¥',
                    type: 'guide',
                    link: 'uyku-stres.html',
                    priority: 'medium',
                    reason: 'Uyku sorunlarƒ±'
                },
                // Stress management
                {
                    id: 'stress_management',
                    condition: (d) => d.stressLevel === 'high',
                    title: 'Stres Y√∂netimi Rehberi',
                    description: 'Kortizol, duygusal yeme ve stres azaltma teknikleri.',
                    icon: 'üßò',
                    type: 'guide',
                    link: 'uyku-stres.html#stres',
                    priority: 'medium',
                    reason: 'Y√ºksek stres d√ºzeyi'
                },
                // Fatty liver
                {
                    id: 'fatty_liver_guide',
                    condition: (d) => d.existingConditions?.includes('fatty_liver'),
                    title: 'Karaciƒüer Saƒülƒ±ƒüƒ± Rehberi',
                    description: 'Yaƒülƒ± karaciƒüer i√ßin beslenme ve ya≈üam tarzƒ±.',
                    icon: 'ü´ò',
                    type: 'guide',
                    link: 'rehberler.html#karaciger',
                    priority: 'high',
                    reason: 'Yaƒülƒ± karaciƒüer tanƒ±sƒ±'
                },
                // PCOS
                {
                    id: 'pcos_guide',
                    condition: (d) => d.existingConditions?.includes('pcos'),
                    title: 'PCOS Y√∂netimi Rehberi',
                    description: 'ƒ∞ns√ºlin direnci, kilo y√∂netimi ve hormonal denge.',
                    icon: 'üî¨',
                    type: 'guide',
                    link: 'rehberler.html#pcos',
                    priority: 'high',
                    reason: 'PCOS tanƒ±sƒ±'
                }
            ],

            // TOOLS
            tools: [
                {
                    id: 'calorie_calculator',
                    condition: (d) => d.primaryGoal === 'lose_weight' || d.calculatedBMI >= 25,
                    title: 'Kalori ƒ∞htiyacƒ± Hesaplayƒ±cƒ±',
                    description: 'G√ºnl√ºk kalori hedefinizi ve makro daƒüƒ±lƒ±mƒ±nƒ±zƒ± hesaplayƒ±n.',
                    icon: 'üî•',
                    type: 'tool',
                    link: 'araclar.html#calorie',
                    priority: 'high',
                    reason: 'Kilo y√∂netimi i√ßin temel ara√ß'
                },
                {
                    id: 'whr_calculator',
                    condition: (d) => !d.waistCircumference || d.calculatedBMI >= 25,
                    title: 'Bel-Kal√ßa Oranƒ± Hesaplayƒ±cƒ±',
                    description: 'Karƒ±n b√∂lgesi yaƒülanmasƒ± riskinizi deƒüerlendirin.',
                    icon: 'üìè',
                    type: 'tool',
                    link: 'araclar.html#whr',
                    priority: 'medium',
                    reason: 'Visseral yaƒü risk deƒüerlendirmesi'
                }
            ],

            // LIFESTYLE changes
            lifestyle: [
                {
                    id: 'quit_smoking',
                    condition: (d) => d.smoking === 'yes',
                    title: 'Sigarayƒ± Bƒ±rakma Programƒ±',
                    description: 'Saƒülƒ±ƒüƒ±nƒ±z i√ßin yapabileceƒüiniz en √∂nemli deƒüi≈üiklik.',
                    icon: 'üö≠',
                    type: 'lifestyle',
                    link: 'rehberler.html#sigara',
                    priority: 'high',
                    reason: 'Aktif sigara kullanƒ±mƒ±'
                },
                {
                    id: 'reduce_alcohol',
                    condition: (d) => d.alcohol === 'daily' || d.alcohol === 'weekly',
                    title: 'Alkol T√ºketimini Azaltma',
                    description: 'Alkol ve kilo ili≈ükisi, karaciƒüer saƒülƒ±ƒüƒ±.',
                    icon: 'üç∑',
                    type: 'lifestyle',
                    link: 'beslenme.html#alkol',
                    priority: d => d.alcohol === 'daily' ? 'high' : 'medium',
                    reason: 'D√ºzenli alkol t√ºketimi'
                },
                {
                    id: 'increase_activity',
                    condition: (d) => d.activityLevel === 'sedentary',
                    title: 'G√ºnl√ºk Hareket Artƒ±rma',
                    description: '10.000 adƒ±m hedefi, masa ba≈üƒ± molalarƒ±.',
                    icon: 'üö∂',
                    type: 'lifestyle',
                    link: 'egzersiz.html#gunluk',
                    priority: 'high',
                    reason: 'Hareketsiz ya≈üam tarzƒ±'
                },
                {
                    id: 'improve_sleep',
                    condition: (d) => d.sleepHours < 6 || d.sleepQuality === 'poor',
                    title: 'Uyku D√ºzeni ƒ∞yile≈ütirme',
                    description: 'Uyku ve kilo ili≈ükisi, uyku hijyeni.',
                    icon: 'üåô',
                    type: 'lifestyle',
                    link: 'uyku-stres.html#uyku',
                    priority: 'medium',
                    reason: 'Yetersiz veya kalitesiz uyku'
                }
            ],

            // ALERTS (shown as warnings)
            alerts: [
                {
                    id: 'metabolic_syndrome_risk',
                    condition: (d) => d.waistCircumference && 
                        ((d.gender === 'male' && d.waistCircumference >= 94) || 
                         (d.gender === 'female' && d.waistCircumference >= 80)) &&
                        (d.existingConditions?.includes('hypertension') || 
                         d.existingConditions?.includes('prediabetes') ||
                         d.existingConditions?.includes('high_cholesterol')),
                    type: 'warning',
                    message: 'Metabolik sendrom riski tespit edildi. Kapsamlƒ± deƒüerlendirme √∂nerilir.',
                    priority: 'high'
                },
                {
                    id: 'family_heart_risk',
                    condition: (d) => d.familyHistory?.includes('heart_disease') && 
                        (d.smoking === 'yes' || d.calculatedBMI >= 30),
                    type: 'warning',
                    message: 'Ailede kalp hastalƒ±ƒüƒ± √∂yk√ºs√º + ek risk fakt√∂rleri. Kardiyoloji kontrol√º d√º≈ü√ºn√ºn.',
                    priority: 'medium'
                },
                {
                    id: 'young_obesity',
                    condition: (d) => (d.ageGroup === '18-29' || d.ageGroup === '30-39') && d.calculatedBMI >= 35,
                    type: 'info',
                    message: 'Gen√ß ya≈üta y√ºksek BMI - erken m√ºdahale ile kalƒ±cƒ± sonu√ßlar m√ºmk√ºn.',
                    priority: 'medium'
                }
            ]
        };

        // State
        let currentStep = 0;
        let userData = {};
        let selectedOptions = [];
        
        const messagesContainer = document.getElementById('messages');
        const resultsContainer = document.getElementById('results-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        // Start quiz
        function init() {
            showQuestion(0);
        }

        function showQuestion(index) {
            const question = QUESTIONS[index];
            if (!question) {
                showResults();
                return;
            }

            // Check showIf condition
            if (question.showIf && !question.showIf(userData)) {
                currentStep++;
                showQuestion(currentStep);
                return;
            }

            // Update progress
            const progress = ((index + 1) / QUESTIONS.length) * 100;
            progressFill.style.width = progress + '%';
            progressText.textContent = `Soru ${index + 1}/${QUESTIONS.length}`;

            // Show typing indicator
            showTyping();

            setTimeout(() => {
                removeTyping();
                
                // Parse message with variables
                let message = question.message;
                message = message.replace('{name}', userData.name || '');
                
                addBotMessage(message);

                if (question.type === 'info' && question.auto) {
                    setTimeout(() => {
                        currentStep++;
                        showQuestion(currentStep);
                    }, question.delay || 1500);
                } else {
                    showInput(question);
                }
            }, 800);
        }

        function showTyping() {
            const msg = document.createElement('div');
            msg.className = 'message bot';
            msg.id = 'typing';
            msg.innerHTML = `
                <div class="avatar bot">üë©‚Äç‚öïÔ∏è</div>
                <div class="bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function addBotMessage(text, extras = '') {
            const msg = document.createElement('div');
            msg.className = 'message bot';
            msg.innerHTML = `
                <div class="avatar bot">üë©‚Äç‚öïÔ∏è</div>
                <div class="bubble">${text}${extras}</div>
            `;
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addUserMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'message user';
            msg.innerHTML = `
                <div class="avatar user">üë§</div>
                <div class="bubble">${text}</div>
            `;
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showInput(question) {
            const container = document.createElement('div');
            container.className = 'input-container';
            container.id = 'current-input';

            switch(question.type) {
                case 'text':
                    container.innerHTML = `
                        <input type="text" class="text-input" id="text-input" 
                            placeholder="${question.placeholder || ''}" autofocus>
                        <button class="continue-btn" onclick="submitText('${question.field}')">Devam ‚Üí</button>
                    `;
                    break;

                case 'number':
                    container.innerHTML = `
                        <input type="number" class="text-input" id="number-input" 
                            placeholder="${question.placeholder || ''}">
                        ${question.optional ? `<button class="option-btn" style="margin-top:0.5rem" onclick="skipQuestion()">${question.skipLabel}</button>` : ''}
                        <button class="continue-btn" onclick="submitNumber('${question.field}')">Devam ‚Üí</button>
                    `;
                    break;

                case 'single':
                    let optionsHtml = '<div class="options-container">';
                    question.options.forEach(opt => {
                        optionsHtml += `<button class="option-btn" data-value="${opt.value}" data-risk="${opt.riskScore || 0}" data-motivation="${opt.motivationScore || 0}" onclick="selectOption(this, '${question.field}')">${opt.label}</button>`;
                    });
                    optionsHtml += '</div>';
                    container.innerHTML = optionsHtml;
                    break;

                case 'multi':
                    let multiHtml = '<div class="options-container">';
                    question.options.forEach(opt => {
                        multiHtml += `<button class="option-btn multi-select" data-value="${opt.value}" data-risk="${opt.riskScore || 0}" data-exclusive="${opt.exclusive || false}" onclick="toggleMultiOption(this)">${opt.label}</button>`;
                    });
                    multiHtml += '</div>';
                    multiHtml += `<button class="continue-btn" id="multi-continue" onclick="submitMulti('${question.field}')" disabled>Devam ‚Üí</button>`;
                    container.innerHTML = multiHtml;
                    selectedOptions = [];
                    break;

                case 'measurements':
                    container.innerHTML = `
                        <div class="input-row">
                            <div class="input-group">
                                <label>Boy (cm)</label>
                                <input type="number" class="text-input" id="height-input" placeholder="170">
                            </div>
                            <div class="input-group">
                                <label>Kilo (kg)</label>
                                <input type="number" class="text-input" id="weight-input" placeholder="70">
                            </div>
                        </div>
                        <button class="continue-btn" onclick="submitMeasurements()">Devam ‚Üí</button>
                    `;
                    break;

                case 'slider':
                    container.innerHTML = `
                        <div class="slider-container">
                            <div class="slider-value" id="slider-value">${question.default} ${question.unit}</div>
                            <input type="range" class="slider" id="slider-input" 
                                min="${question.min}" max="${question.max}" value="${question.default}"
                                oninput="updateSlider(this.value, '${question.unit}')">
                            <div class="slider-labels">
                                <span>${question.min} ${question.unit}</span>
                                <span>${question.max} ${question.unit}</span>
                            </div>
                        </div>
                        <button class="continue-btn" onclick="submitSlider('${question.field}')">Devam ‚Üí</button>
                    `;
                    break;
            }

            const lastMessage = messagesContainer.lastElementChild;
            lastMessage.querySelector('.bubble').appendChild(container);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Focus first input
            const firstInput = container.querySelector('input');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        function removeCurrentInput() {
            const input = document.getElementById('current-input');
            if (input) input.remove();
        }

        // Input handlers
        function submitText(field) {
            const input = document.getElementById('text-input');
            const value = input.value.trim();
            if (!value) return;

            userData[field] = value;
            removeCurrentInput();
            addUserMessage(value);
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function submitNumber(field) {
            const input = document.getElementById('number-input');
            const value = parseFloat(input.value);
            if (!value) return;

            userData[field] = value;
            removeCurrentInput();
            addUserMessage(value + ' cm');
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function skipQuestion() {
            removeCurrentInput();
            addUserMessage('Bilmiyorum');
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function selectOption(btn, field) {
            const value = btn.dataset.value;
            const risk = parseInt(btn.dataset.risk) || 0;
            const motivation = parseInt(btn.dataset.motivation) || 0;

            userData[field] = value;
            userData.riskScore = (userData.riskScore || 0) + risk;
            if (motivation) userData.motivationScore = motivation;

            removeCurrentInput();
            addUserMessage(btn.textContent);
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function toggleMultiOption(btn) {
            const value = btn.dataset.value;
            const isExclusive = btn.dataset.exclusive === 'true';

            if (isExclusive) {
                // Clear all others
                document.querySelectorAll('.multi-select').forEach(b => b.classList.remove('selected'));
                selectedOptions = [value];
                btn.classList.add('selected');
            } else {
                // Remove exclusive option if selected
                const exclusiveBtn = document.querySelector('.multi-select[data-exclusive="true"]');
                if (exclusiveBtn) {
                    exclusiveBtn.classList.remove('selected');
                    selectedOptions = selectedOptions.filter(v => v !== exclusiveBtn.dataset.value);
                }

                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    selectedOptions = selectedOptions.filter(v => v !== value);
                } else {
                    btn.classList.add('selected');
                    selectedOptions.push(value);
                }
            }

            document.getElementById('multi-continue').disabled = selectedOptions.length === 0;
        }

        function submitMulti(field) {
            if (selectedOptions.length === 0) return;

            // Calculate risk from selections
            let totalRisk = 0;
            document.querySelectorAll('.multi-select.selected').forEach(btn => {
                totalRisk += parseInt(btn.dataset.risk) || 0;
            });
            userData.riskScore = (userData.riskScore || 0) + totalRisk;

            userData[field] = selectedOptions.slice();
            
            const labels = Array.from(document.querySelectorAll('.multi-select.selected'))
                .map(b => b.textContent).join(', ');
            
            removeCurrentInput();
            addUserMessage(labels);
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function submitMeasurements() {
            const height = parseFloat(document.getElementById('height-input').value);
            const weight = parseFloat(document.getElementById('weight-input').value);

            if (!height || !weight) return;

            userData.height = height;
            userData.weight = weight;

            // Calculate BMI
            const bmi = weight / Math.pow(height / 100, 2);
            userData.calculatedBMI = parseFloat(bmi.toFixed(1));

            // Add BMI risk
            let bmiRisk = 0;
            if (bmi >= 40) bmiRisk = 25;
            else if (bmi >= 35) bmiRisk = 20;
            else if (bmi >= 30) bmiRisk = 15;
            else if (bmi >= 25) bmiRisk = 8;
            else if (bmi < 18.5) bmiRisk = 5;
            userData.riskScore = (userData.riskScore || 0) + bmiRisk;

            removeCurrentInput();
            addUserMessage(`${height} cm, ${weight} kg`);
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        function updateSlider(value, unit) {
            document.getElementById('slider-value').textContent = value + ' ' + unit;
        }

        function submitSlider(field) {
            const value = parseInt(document.getElementById('slider-input').value);
            userData[field] = value;

            // Sleep risk
            if (field === 'sleepHours') {
                let sleepRisk = 0;
                if (value < 5) sleepRisk = 12;
                else if (value < 6) sleepRisk = 8;
                else if (value > 9) sleepRisk = 5;
                userData.riskScore = (userData.riskScore || 0) + sleepRisk;
            }

            removeCurrentInput();
            addUserMessage(value + ' saat');
            
            currentStep++;
            setTimeout(() => showQuestion(currentStep), 500);
        }

        // Generate recommendations with priority scoring
        function generateRecommendations() {
            const recs = [];
            const alerts = [];
            
            // Process all rule categories
            ['urgent', 'treatments', 'guides', 'tools', 'lifestyle'].forEach(category => {
                const rules = RECOMMENDATION_RULES[category] || [];
                rules.forEach(rule => {
                    if (rule.condition && rule.condition(userData)) {
                        // Calculate dynamic priority if function
                        let priority = typeof rule.priority === 'function' 
                            ? rule.priority(userData) 
                            : rule.priority;
                        
                        recs.push({
                            ...rule,
                            priority: priority,
                            category: category
                        });
                    }
                });
            });

            // Process alerts separately
            (RECOMMENDATION_RULES.alerts || []).forEach(alert => {
                if (alert.condition && alert.condition(userData)) {
                    alerts.push(alert);
                }
            });

            // Store alerts for display
            userData.alerts = alerts;

            // Sort by priority: urgent > high > medium > low
            const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3, undefined: 4 };
            recs.sort((a, b) => {
                const pA = priorityOrder[a.priority] ?? 4;
                const pB = priorityOrder[b.priority] ?? 4;
                return pA - pB;
            });

            return recs;
        }

        // Calculate health score (inverse of risk)
        function calculateHealthScore() {
            const maxRisk = 150; // Maximum possible risk score
            const risk = Math.min(userData.riskScore || 0, maxRisk);
            return Math.round(100 - (risk / maxRisk) * 100);
        }

        // Get BMI category
        function getBMICategory(bmi) {
            if (bmi < 18.5) return { label: 'Zayƒ±f', class: 'warning' };
            if (bmi < 25) return { label: 'Normal', class: 'good' };
            if (bmi < 30) return { label: 'Fazla Kilolu', class: 'warning' };
            if (bmi < 35) return { label: 'Obez (Sƒ±nƒ±f 1)', class: 'alert' };
            if (bmi < 40) return { label: 'Obez (Sƒ±nƒ±f 2)', class: 'alert' };
            return { label: 'Obez (Sƒ±nƒ±f 3)', class: 'alert' };
        }

        // Get risk level
        function getRiskLevel(score) {
            if (score >= 75) return { label: 'D√º≈ü√ºk Risk', class: 'low' };
            if (score >= 50) return { label: 'Orta Risk', class: 'moderate' };
            return { label: 'Y√ºksek Risk', class: 'high' };
        }

        // Show results
        function showResults() {
            userData.completedAt = new Date().toISOString();
            userData.healthScore = calculateHealthScore();
            
            const recommendations = generateRecommendations();
            userData.recommendations = recommendations.map(r => r.id);

            // Build final JSON
            const outputJSON = {
                patient: {
                    name: userData.name,
                    ageGroup: userData.ageGroup,
                    gender: userData.gender,
                    height: userData.height,
                    weight: userData.weight,
                    bmi: userData.calculatedBMI,
                    waistCircumference: userData.waistCircumference || null
                },
                lifestyle: {
                    activityLevel: userData.activityLevel,
                    dietQuality: userData.dietQuality,
                    sleepHours: userData.sleepHours,
                    sleepQuality: userData.sleepQuality,
                    stressLevel: userData.stressLevel,
                    smoking: userData.smoking,
                    alcohol: userData.alcohol
                },
                medical: {
                    existingConditions: userData.existingConditions || [],
                    familyHistory: userData.familyHistory || []
                },
                goals: {
                    primaryGoal: userData.primaryGoal,
                    treatmentInterest: userData.treatmentInterest || [],
                    previousAttempts: userData.previousAttempts,
                    motivationLevel: userData.motivationLevel
                },
                assessment: {
                    healthScore: userData.healthScore,
                    riskScore: userData.riskScore,
                    riskLevel: getRiskLevel(userData.healthScore).label,
                    bmiCategory: getBMICategory(userData.calculatedBMI).label,
                    alerts: (userData.alerts || []).map(a => ({
                        type: a.type,
                        message: a.message,
                        priority: a.priority
                    })),
                    recommendations: recommendations.slice(0, 8).map(r => ({
                        id: r.id,
                        category: r.category,
                        type: r.type,
                        title: r.title,
                        description: r.description,
                        priority: r.priority || 'normal',
                        reason: r.reason || null,
                        link: r.link
                    }))
                },
                metadata: {
                    completedAt: userData.completedAt,
                    version: '1.0'
                }
            };

            // Store for API
            window.assessmentResult = outputJSON;
            console.log('Assessment JSON:', JSON.stringify(outputJSON, null, 2));

            // Hide chat, show results
            document.querySelector('.chat-container').style.display = 'none';
            resultsContainer.style.display = 'block';

            const bmiCat = getBMICategory(userData.calculatedBMI);
            const riskLevel = getRiskLevel(userData.healthScore);

            resultsContainer.innerHTML = `
                <div class="results-header">
                    <h1>${userData.name}, sonu√ßlarƒ±nƒ±z hazƒ±r! üéâ</h1>
                    <p>Ecem yanƒ±tlarƒ±nƒ±zƒ± analiz etti ve size √∂zel √∂neriler hazƒ±rladƒ±</p>
                </div>

                <div class="score-circle" style="--score: ${userData.healthScore}">
                    <div class="score-inner">
                        <div class="score-value">${userData.healthScore}</div>
                        <div class="score-label">Saƒülƒ±k Skoru</div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <span class="risk-badge ${riskLevel.class}">${riskLevel.label}</span>
                </div>

                <div class="summary-section">
                    <h3 class="summary-title">üìä √ñzet</h3>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h4>V√ºcut Kitle ƒ∞ndeksi</h4>
                            <div class="value">${userData.calculatedBMI}</div>
                            <div class="status ${bmiCat.class}">${bmiCat.label}</div>
                        </div>
                        <div class="summary-card">
                            <h4>Aktivite D√ºzeyi</h4>
                            <div class="value">${getActivityLabel(userData.activityLevel)}</div>
                            <div class="status ${userData.activityLevel === 'sedentary' ? 'warning' : 'good'}">
                                ${userData.activityLevel === 'sedentary' ? 'Artƒ±rƒ±lmalƒ±' : 'ƒ∞yi'}
                            </div>
                        </div>
                        <div class="summary-card">
                            <h4>Uyku</h4>
                            <div class="value">${userData.sleepHours} saat</div>
                            <div class="status ${userData.sleepHours >= 7 ? 'good' : 'warning'}">
                                ${userData.sleepHours >= 7 ? 'Yeterli' : 'Yetersiz'}
                            </div>
                        </div>
                        <div class="summary-card">
                            <h4>Motivasyon</h4>
                            <div class="value">${userData.motivationScore || 50}%</div>
                            <div class="status ${userData.motivationScore >= 80 ? 'good' : 'warning'}">
                                ${userData.motivationScore >= 80 ? 'Y√ºksek' : 'Orta'}
                            </div>
                        </div>
                    </div>
                </div>

                ${userData.alerts && userData.alerts.length > 0 ? `
                <div class="alerts-section" style="margin-bottom: 2rem;">
                    ${userData.alerts.map(alert => `
                        <div class="alert-card ${alert.type}" style="
                            padding: 1rem 1.25rem;
                            border-radius: 12px;
                            margin-bottom: 0.75rem;
                            display: flex;
                            align-items: flex-start;
                            gap: 0.75rem;
                            ${alert.type === 'warning' ? 'background: #FEF3C7; border-left: 4px solid #F59E0B;' : ''}
                            ${alert.type === 'info' ? 'background: #DBEAFE; border-left: 4px solid #3B82F6;' : ''}
                        ">
                            <span style="font-size: 1.25rem;">${alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                            <p style="margin: 0; color: ${alert.type === 'warning' ? '#92400E' : '#1E40AF'}; font-size: 0.95rem;">${alert.message}</p>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="recommendations">
                    <h3 class="summary-title">üéØ Size √ñzel √ñneriler</h3>
                    ${recommendations.slice(0, 6).map(rec => `
                        <a href="${rec.link}" class="rec-card ${rec.priority === 'urgent' ? 'urgent-rec' : ''}" style="${rec.priority === 'urgent' ? 'border: 2px solid #DC2626; background: #FEF2F2;' : ''}">
                            <div class="rec-icon ${rec.type}">${rec.icon}</div>
                            <div class="rec-content">
                                <h4>${rec.title}${rec.priority === 'urgent' ? '<span class="priority-tag high" style="background:#FEE2E2;color:#991B1B;">Acil</span>' : rec.priority === 'high' ? '<span class="priority-tag high">√ñncelikli</span>' : ''}</h4>
                                <p>${rec.description}</p>
                                ${rec.reason ? `<small style="color: #9CA3AF; font-size: 0.8rem;">üìå ${rec.reason}</small>` : ''}
                            </div>
                            <span class="rec-arrow">‚Üí</span>
                        </a>
                    `).join('')}
                </div>

                <div class="results-actions">
                    <a href="araclar.html" class="action-btn primary">Ara√ßlarƒ± Kullan</a>
                    <button class="action-btn secondary" onclick="downloadResults()">Sonu√ßlarƒ± ƒ∞ndir</button>
                </div>

                <div class="json-debug" id="json-debug">
                    <pre>${JSON.stringify(outputJSON, null, 2)}</pre>
                </div>
            `;

            // Send to console/API
            sendToAPI(outputJSON);
        }

        function getActivityLabel(level) {
            const labels = {
                sedentary: 'Hareketsiz',
                light: 'Hafif',
                moderate: 'Orta',
                active: 'Aktif'
            };
            return labels[level] || level;
        }

        function downloadResults() {
            const blob = new Blob([JSON.stringify(window.assessmentResult, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `uzunyasa-sonuc-${userData.name?.toLowerCase() || 'anonim'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function sendToAPI(data) {
            // Log for now - connect to backend later
            console.log('üì§ Assessment ready for API:', data);
            
            // Future: POST to backend
            // fetch('/api/assessment', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(data)
            // });
        }

        // Toggle JSON debug view
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd' && e.ctrlKey) {
                const debug = document.getElementById('json-debug');
                if (debug) debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Start
        init();
    </script>
</body>
</html>
