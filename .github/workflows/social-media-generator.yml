name: Social Media Content Generator

on:
  push:
    paths:
      - 'pages/blog/*.html'
  workflow_dispatch:
    inputs:
      blog_file:
        description: 'Blog file to process (e.g., glp1-tam-rehber.html)'
        required: true
        default: 'bariatrik-cerrahi-rehberi.html'

jobs:
  generate-social-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Puppeteer
        run: |
          cd scripts
          npm install puppeteer
          cd ..
          
      - name: Install fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto fonts-noto-color-emoji
          
      - name: Detect blog files to process
        id: detect
        run: |
          if [ "${{ github.event.inputs.blog_file }}" != "" ]; then
            echo "files=${{ github.event.inputs.blog_file }}" >> $GITHUB_OUTPUT
            echo "Processing manual input: ${{ github.event.inputs.blog_file }}"
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'pages/blog/*.html' 2>/dev/null | tr '\n' ' ' || echo "")
            echo "files=$CHANGED" >> $GITHUB_OUTPUT
            echo "Processing changed files: $CHANGED"
          fi
          
      - name: Generate social media images
        if: steps.detect.outputs.files != ''
        run: |
          echo "Generating for: ${{ steps.detect.outputs.files }}"
          node scripts/generate-social-images.js ${{ steps.detect.outputs.files }}
        
      - name: Commit and push generated content
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add images/social/ pages/blog/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ–¼ï¸ Auto-generate social media content for ${{ steps.detect.outputs.files }}"
            git push
          fi
          
      - name: Summary
        run: |
          echo "## ðŸ“± Social Media Content Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Processed:** ${{ steps.detect.outputs.files }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated files:**" >> $GITHUB_STEP_SUMMARY
          ls -la images/social/ 2>/dev/null || echo "No images yet"
          
      # Email notification (optional - enable when secrets are set)
      # - name: Send email notification
      #   if: ${{ secrets.EMAIL_USERNAME != '' }}
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 587
      #     username: ${{ secrets.EMAIL_USERNAME }}
      #     password: ${{ secrets.EMAIL_PASSWORD }}
      #     subject: "ðŸŒ¿ UzunYaÅŸa - Yeni Blog Ä°Ã§eriÄŸi HazÄ±r!"
      #     to: ${{ secrets.NOTIFY_EMAIL }}
      #     from: UzunYaÅŸa Bot
      #     body: "Social media content generated for: ${{ steps.detect.outputs.files }}"
