name: Auto Blog Generator

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog topic (optional - random if empty)'
        required: false
        type: string
  schedule:
    - cron: '0 6 * * *'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Select topic
        id: topic
        run: |
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            echo "selected=${{ github.event.inputs.topic }}" >> $GITHUB_OUTPUT
          else
            TOPICS=(
              "GLP-1 ila√ßlarƒ±: Ozempic, Wegovy ve Mounjaro kar≈üƒ±la≈ütƒ±rmasƒ±"
              "Tirzepatide ile kilo verme: Son ara≈ütƒ±rmalar"
              "Aralƒ±klƒ± oru√ß: 16:8 ve 5:2 y√∂ntemleri"
              "Akdeniz diyeti ve kalp saƒülƒ±ƒüƒ±"
              "Protein alƒ±mƒ± ve kas kaybƒ±nƒ± √∂nleme"
              "Uyku eksikliƒüi ve kilo alma ili≈ükisi"
              "HIIT egzersiz ve metabolizma hƒ±zlandƒ±rma"
              "Gut mikrobiyomu ve obezite baƒülantƒ±sƒ±"
              "Karbonhidrat kƒ±sƒ±tlama diyetleri"
              "Y√ºr√ºy√º≈ü ve kilo verme: G√ºnde ka√ß adƒ±m"
              "Stres ve kilo alma mekanizmasƒ±"
              "Kahvaltƒ± atlama: Faydalƒ± mƒ± zararlƒ± mƒ±"
              "ƒ∞ns√ºlin direnci ve kilo verme zorluƒüu"
              "Doƒüal i≈ütah bastƒ±rƒ±cƒ± besinler"
              "Metabolik sendrom ve ya≈üam tarzƒ± deƒüi≈üiklikleri"
            )
            RANDOM_INDEX=$((RANDOM % ${#TOPICS[@]}))
            echo "selected=${TOPICS[$RANDOM_INDEX]}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate blog
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Generating blog for: ${{ steps.topic.outputs.selected }}"
          node scripts/auto-blog-generator.js --topic "${{ steps.topic.outputs.selected }}"
      
      - name: Update index
        run: node scripts/update-blog-index.js
      
      - name: Commit and push
        run: |
          git config user.email "bot@uzunyasa.com"
          git config user.name "UzunYa≈üa Bot"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìù Yeni blog: ${{ steps.topic.outputs.selected }}"
            git push
          fi
